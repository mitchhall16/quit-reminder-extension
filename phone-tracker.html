<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Alarm Tracker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 100%);
      color: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      text-align: center;
      max-width: 400px;
      width: 100%;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #64748b;
      font-size: 0.9rem;
      margin-bottom: 30px;
    }

    /* Pairing Screen */
    .pairing-screen {
      display: block;
    }

    .code-input-container {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .code-digit {
      width: 60px;
      height: 70px;
      font-size: 2rem;
      text-align: center;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      color: white;
      font-family: monospace;
    }

    .code-digit:focus {
      outline: none;
      border-color: #4ade80;
      background: rgba(74, 222, 128, 0.1);
    }

    .pair-btn {
      width: 100%;
      padding: 18px;
      font-size: 1.1rem;
      font-weight: 600;
      background: linear-gradient(135deg, #4ade80, #22c55e);
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      margin-bottom: 15px;
    }

    .pair-btn:disabled {
      background: #333;
      color: #666;
    }

    .status-text {
      color: #64748b;
      font-size: 0.9rem;
    }

    .status-text.error {
      color: #f87171;
    }

    .status-text.success {
      color: #4ade80;
    }

    /* Paired/Waiting Screen */
    .waiting-screen {
      display: none;
    }

    .paired-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 15px 25px;
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      border-radius: 12px;
      margin-bottom: 30px;
    }

    .paired-dot {
      width: 12px;
      height: 12px;
      background: #4ade80;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .paired-text {
      color: #4ade80;
      font-weight: 500;
    }

    .waiting-message {
      font-size: 1.2rem;
      color: #94a3b8;
      margin-bottom: 20px;
    }

    .waiting-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .disconnect-btn {
      padding: 12px 30px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: #94a3b8;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 30px;
    }

    /* Alarm Active Screen */
    .alarm-active-screen {
      display: none;
    }

    .alarm-active-screen.show {
      display: block;
    }

    .go-outside-header {
      font-size: 1.8rem;
      font-weight: 700;
      color: #f87171;
      margin-bottom: 10px;
      animation: shake 0.5s infinite;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-3px); }
      75% { transform: translateX(3px); }
    }

    .instruction {
      font-size: 1.1rem;
      color: #fbbf24;
      margin-bottom: 30px;
    }

    .distance-big {
      font-size: 5rem;
      font-weight: 700;
      color: #f87171;
      line-height: 1;
      margin-bottom: 10px;
    }

    .distance-big.close {
      color: #fbbf24;
    }

    .distance-big.success {
      color: #4ade80;
    }

    .distance-unit {
      font-size: 1.5rem;
      color: #64748b;
    }

    .target-info {
      color: #64748b;
      margin-bottom: 20px;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #f87171, #fbbf24, #4ade80);
      transition: width 0.3s;
    }

    .gps-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: #22d3ee;
      font-size: 0.9rem;
    }

    .gps-dot {
      width: 8px;
      height: 8px;
      background: #22d3ee;
      border-radius: 50%;
      animation: pulse 1s infinite;
    }

    /* Success Screen */
    .success-screen {
      display: none;
    }

    .success-screen.show {
      display: block;
    }

    .success-icon {
      font-size: 5rem;
      margin-bottom: 20px;
    }

    .success-title {
      font-size: 2rem;
      color: #4ade80;
      margin-bottom: 15px;
    }

    .success-message {
      color: #94a3b8;
      font-size: 1.1rem;
      line-height: 1.6;
      margin-bottom: 30px;
    }

    .done-btn {
      padding: 15px 40px;
      background: linear-gradient(135deg, #4ade80, #22c55e);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Pairing Screen -->
    <div class="pairing-screen" id="pairingScreen">
      <h1>Alarm Phone Tracker</h1>
      <p class="subtitle">Enter the code from your computer</p>

      <div class="code-input-container">
        <input type="tel" class="code-digit" maxlength="1" id="digit1" inputmode="numeric">
        <input type="tel" class="code-digit" maxlength="1" id="digit2" inputmode="numeric">
        <input type="tel" class="code-digit" maxlength="1" id="digit3" inputmode="numeric">
        <input type="tel" class="code-digit" maxlength="1" id="digit4" inputmode="numeric">
      </div>

      <button class="pair-btn" id="pairBtn" disabled>Connect</button>
      <p class="status-text" id="pairStatus">Enter 4-digit code to pair</p>
    </div>

    <!-- Waiting Screen -->
    <div class="waiting-screen" id="waitingScreen">
      <div class="paired-indicator">
        <div class="paired-dot"></div>
        <span class="paired-text">Connected to computer</span>
      </div>

      <div class="waiting-icon">‚úÖ</div>
      <p class="waiting-message">You're all set!</p>

      <button class="pair-btn" id="checkAlarmBtn" style="margin: 20px 0; background: linear-gradient(135deg, #f87171, #dc2626);">
        üîî Alarm Ringing? Tap Here!
      </button>

      <button class="disconnect-btn" id="testGpsBtn" style="margin-bottom: 10px;">
        üìç Test GPS Location
      </button>

      <p class="status-text" style="max-width: 300px; line-height: 1.6;">
        When alarm rings, tap the button above or just reopen this page.
      </p>

      <button class="disconnect-btn" id="disconnectBtn">Disconnect</button>

      <div style="margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 0.75rem; color: #64748b;">
        Debug: Room <span id="debugRoomCode">-</span> |
        MQTT: <span id="debugMqttStatus">-</span>
      </div>
    </div>

    <!-- Alarm Active Screen -->
    <div class="alarm-active-screen" id="alarmActiveScreen">
      <div class="go-outside-header">WAKE UP!</div>
      <p class="instruction">Walk outside to turn off the alarm!</p>

      <div class="distance-big" id="distanceDisplay">0<span class="distance-unit">m</span></div>
      <p class="target-info">Need to walk <span id="targetDisplay">10</span>m from bed</p>

      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>

      <div class="gps-info">
        <div class="gps-dot"></div>
        <span id="gpsStatus">Getting GPS...</span>
      </div>
    </div>

    <!-- Success Screen -->
    <div class="success-screen" id="successScreen">
      <div class="success-icon">üåÖ</div>
      <div class="success-title">You did it!</div>
      <p class="success-message">
        Alarm dismissed. You got up and went outside - that's the hardest part done!
        Have a great day.
      </p>
      <button class="done-btn" id="doneBtn">Done</button>
    </div>
  </div>

  <!-- MQTT.js library -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <script>
    // State
    let mqttClient = null;
    let roomCode = '';
    let bedLocation = null;
    let targetDistance = 10;
    let locationWatchId = null;
    let isAlarmActive = false;

    // DOM elements
    const pairingScreen = document.getElementById('pairingScreen');
    const waitingScreen = document.getElementById('waitingScreen');
    const alarmActiveScreen = document.getElementById('alarmActiveScreen');
    const successScreen = document.getElementById('successScreen');
    const pairBtn = document.getElementById('pairBtn');
    const pairStatus = document.getElementById('pairStatus');
    const digits = [
      document.getElementById('digit1'),
      document.getElementById('digit2'),
      document.getElementById('digit3'),
      document.getElementById('digit4')
    ];

    // Auto-focus and auto-advance digit inputs
    digits.forEach((digit, index) => {
      digit.addEventListener('input', (e) => {
        const val = e.target.value.replace(/\D/g, '');
        e.target.value = val.slice(-1);

        if (val && index < 3) {
          digits[index + 1].focus();
        }

        checkCodeComplete();
      });

      digit.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
          digits[index - 1].focus();
        }
      });

      digit.addEventListener('focus', () => {
        e.target.select();
      });
    });

    function checkCodeComplete() {
      const code = digits.map(d => d.value).join('');
      pairBtn.disabled = code.length !== 4;
    }

    // Connect button
    pairBtn.addEventListener('click', () => {
      roomCode = digits.map(d => d.value).join('');
      if (roomCode.length !== 4) return;

      connectToRoom(roomCode);
    });

    // Disconnect button
    document.getElementById('disconnectBtn').addEventListener('click', () => {
      disconnect();
      showScreen('pairing');
    });

    // Done button
    document.getElementById('doneBtn').addEventListener('click', () => {
      disconnect();
      showScreen('pairing');
      digits.forEach(d => d.value = '');
      pairBtn.disabled = true;
    });

    function showScreen(screen) {
      pairingScreen.style.display = 'none';
      waitingScreen.style.display = 'none';
      alarmActiveScreen.classList.remove('show');
      successScreen.classList.remove('show');

      switch(screen) {
        case 'pairing':
          pairingScreen.style.display = 'block';
          break;
        case 'waiting':
          waitingScreen.style.display = 'block';
          break;
        case 'active':
          alarmActiveScreen.classList.add('show');
          break;
        case 'success':
          successScreen.classList.add('show');
          break;
      }
    }

    function connectToRoom(code) {
      pairStatus.textContent = 'Connecting...';
      pairStatus.className = 'status-text';
      roomCode = code;

      console.log('Connecting to room:', code);

      // Connect to free public MQTT broker via WebSocket
      const clientId = 'phone_' + Math.random().toString(16).substr(2, 8);

      mqttClient = mqtt.connect('wss://broker.hivemq.com:8884/mqtt', {
        clientId: clientId,
        keepalive: 60,
        clean: true,
        reconnectPeriod: 5000
      });

      mqttClient.on('connect', () => {
        console.log('Connected to MQTT broker!');

        // Update debug info
        const debugRoom = document.getElementById('debugRoomCode');
        const debugMqtt = document.getElementById('debugMqttStatus');
        if (debugRoom) debugRoom.textContent = code;
        if (debugMqtt) debugMqtt.textContent = 'Connected';

        // Subscribe to room topic
        const topic = `wakeupalarm/${code}`;
        console.log('Subscribing to:', topic);

        mqttClient.subscribe(topic, (err) => {
          if (err) {
            console.error('Subscribe error:', err);
            pairStatus.textContent = 'Failed to join room';
            pairStatus.className = 'status-text error';
            return;
          }

          console.log('Subscribed! Sending phone_joined...');

          // Send "phone joined" message and request alarm status
          mqttClient.publish(topic, JSON.stringify({
            type: 'phone_joined',
            timestamp: Date.now()
          }));

          // Ask computer if alarm is currently ringing
          setTimeout(() => {
            mqttClient.publish(topic, JSON.stringify({
              type: 'request_status'
            }));
          }, 500);

          pairStatus.textContent = 'Connected!';
          pairStatus.className = 'status-text success';

          // Save the room code for reconnection
          localStorage.setItem('phoneRoomCode', code);

          setTimeout(() => showScreen('waiting'), 1000);
        });
      });

      mqttClient.on('message', (topic, message) => {
        console.log('Received message:', message.toString());
        try {
          const data = JSON.parse(message.toString());
          handleMessage(data);
        } catch (e) {
          console.error('Failed to parse message:', e);
        }
      });

      mqttClient.on('error', (err) => {
        console.error('MQTT error:', err);
        pairStatus.textContent = 'Connection error. Try again.';
        pairStatus.className = 'status-text error';
      });

      mqttClient.on('close', () => {
        console.log('Connection closed');
        if (isAlarmActive) {
          console.log('Reconnecting because alarm is active...');
        }
      });

      mqttClient.on('reconnect', () => {
        console.log('Reconnecting...');
        pairStatus.textContent = 'Reconnecting...';
      });
    }

    function handleMessage(data) {
      console.log('Received:', data);

      switch (data.type) {
        case 'alarm_ringing':
        case 'alarm_status':  // Also handle status updates
          // Alarm started! Begin tracking
          bedLocation = data.bedLocation;
          targetDistance = data.targetDistance || 10;
          document.getElementById('targetDisplay').textContent = targetDistance;
          isAlarmActive = true;
          showScreen('active');
          startLocationTracking();

          // Vibrate if supported
          if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200, 100, 200]);
          }
          break;

        case 'alarm_stopped':
          // Computer stopped the alarm (snooze or manual)
          isAlarmActive = false;
          stopLocationTracking();
          showScreen('waiting');
          break;

        case 'ping':
          // Respond to keep connection alive
          sendMessage({ type: 'pong' });
          break;
      }
    }

    // When phone connects, ask computer for current alarm status
    function requestAlarmStatus() {
      sendMessage({ type: 'request_status' });
    }

    function sendMessage(data) {
      if (mqttClient && mqttClient.connected) {
        const topic = `wakeupalarm/${roomCode}`;
        mqttClient.publish(topic, JSON.stringify(data));
      }
    }

    function disconnect() {
      stopLocationTracking();
      isAlarmActive = false;
      if (mqttClient) {
        mqttClient.end();
        mqttClient = null;
      }
    }

    // Geolocation
    function startLocationTracking() {
      const gpsStatus = document.getElementById('gpsStatus');

      if (!navigator.geolocation) {
        gpsStatus.textContent = 'GPS not available';
        return;
      }

      gpsStatus.textContent = 'Getting location...';

      locationWatchId = navigator.geolocation.watchPosition(
        (position) => {
          const currentLat = position.coords.latitude;
          const currentLng = position.coords.longitude;

          if (bedLocation) {
            const distance = calculateDistance(
              bedLocation.lat, bedLocation.lng,
              currentLat, currentLng
            );
            updateDistanceUI(distance);

            // Send position update to computer
            sendMessage({
              type: 'location_update',
              distance: Math.round(distance),
              lat: currentLat,
              lng: currentLng
            });

            // Check if far enough
            if (distance >= targetDistance) {
              alarmDismissed();
            }
          }

          gpsStatus.textContent = `Accuracy: ${Math.round(position.coords.accuracy)}m`;
        },
        (error) => {
          gpsStatus.textContent = `GPS error: ${error.message}`;
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    function stopLocationTracking() {
      if (locationWatchId !== null) {
        navigator.geolocation.clearWatch(locationWatchId);
        locationWatchId = null;
      }
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371e3; // Earth radius in meters
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lng2 - lng1) * Math.PI / 180;

      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c;
    }

    function updateDistanceUI(distance) {
      const distanceDisplay = document.getElementById('distanceDisplay');
      const progressFill = document.getElementById('progressFill');

      const rounded = Math.round(distance);
      distanceDisplay.innerHTML = `${rounded}<span class="distance-unit">m</span>`;

      const progress = Math.min(100, (distance / targetDistance) * 100);
      progressFill.style.width = progress + '%';

      distanceDisplay.classList.remove('close', 'success');
      if (progress >= 100) {
        distanceDisplay.classList.add('success');
      } else if (progress >= 50) {
        distanceDisplay.classList.add('close');
      }
    }

    function alarmDismissed() {
      isAlarmActive = false;
      stopLocationTracking();

      // Tell computer to stop alarm
      sendMessage({
        type: 'dismiss_alarm',
        timestamp: Date.now()
      });

      // Vibrate success
      if (navigator.vibrate) {
        navigator.vibrate([100, 50, 100, 50, 300]);
      }

      showScreen('success');
    }

    // Prevent sleep on mobile (request wake lock if available)
    async function requestWakeLock() {
      if ('wakeLock' in navigator) {
        try {
          await navigator.wakeLock.request('screen');
          console.log('Wake lock active');
        } catch (e) {
          console.log('Wake lock failed:', e);
        }
      }
    }

    // Keep screen awake when alarm is active
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && isAlarmActive) {
        requestWakeLock();
      }
    });

    // Test GPS button
    document.getElementById('testGpsBtn').addEventListener('click', () => {
      document.getElementById('testGpsBtn').textContent = 'Getting location...';

      if (!navigator.geolocation) {
        alert('GPS not supported on this browser!');
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude.toFixed(6);
          const lng = position.coords.longitude.toFixed(6);
          const acc = Math.round(position.coords.accuracy);
          alert(`GPS Working!\n\nLat: ${lat}\nLng: ${lng}\nAccuracy: ${acc}m`);
          document.getElementById('testGpsBtn').textContent = 'üìç Test GPS Location';
        },
        (error) => {
          alert(`GPS Error: ${error.message}\n\nMake sure Location Services is enabled and you allowed permission.`);
          document.getElementById('testGpsBtn').textContent = 'üìç Test GPS Location';
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });

    // Check alarm button - manually request status
    document.getElementById('checkAlarmBtn').addEventListener('click', () => {
      console.log('Manually checking alarm status...');
      if (mqttClient && mqttClient.connected) {
        sendMessage({ type: 'request_status' });
        document.getElementById('checkAlarmBtn').textContent = 'Checking...';

        // If no response in 2 seconds, show error
        setTimeout(() => {
          if (!isAlarmActive) {
            document.getElementById('checkAlarmBtn').textContent = 'üîî Alarm Ringing? Tap Here!';
            alert('No response from computer. Make sure:\n1. Computer alarm page is open\n2. Same room code on both devices\n3. Alarm is actually ringing');
          }
        }, 2000);
      } else {
        alert('Not connected! Enter the room code and tap Connect first.');
      }
    });

    // Check for saved room code and auto-fill
    const savedRoomCode = localStorage.getItem('phoneRoomCode');
    if (savedRoomCode && savedRoomCode.length === 4) {
      // Auto-fill the code
      for (let i = 0; i < 4; i++) {
        digits[i].value = savedRoomCode[i];
      }
      pairBtn.disabled = false;
      pairStatus.textContent = 'Last code auto-filled. Tap Connect or enter new code.';

      // Auto-connect after a short delay
      setTimeout(() => {
        connectToRoom(savedRoomCode);
      }, 500);
    } else {
      // Focus first digit on load
      digits[0].focus();
    }
  </script>
</body>
</html>
